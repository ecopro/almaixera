{% extends "base.html" %}

{% block estilscss %}
.item input {
    width: 70px;
}
.total , .totalinc {
    width: 7em;
    text-align: center;
}
.totalbox {
    display: inline-block;
}
@media (max-device-width: 650px) , (max-width: 650px) {
    .item {
        width: 100%;
    }
    .item select {
        width: 100%;
    }
    .item input , .item subtotal {
        //width: 49%;
    }
}

.parell {
    background-color: #ccc;
}
.parell , .senar {
    display:flex;
}
.prod {
    flex-grow: 2;
}
.parell input , .senar input {
    /*float: right;*/
    width: 70px;
}

.ui-accordion .ui-accordion-header {
    background-color: #86A328;
    border-color: #86A328;
}
{% endblock %}


{% block headextra %}
  <link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
  <link rel="stylesheet" href="/resources/demos/style.css">
  <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
  <script type="text/javascript">
      $( function() {
        $("#accordion").accordion({
            heightStyle: "content"
        });
      });
  </script>
  <style>
    .ui-accordion .ui-accordion-content {
        padding: 0;
    }
  </style>
{% endblock %}


{% block contingut %}
    
    <div class="pissarra">
        <div class="pissarratitol">La Pissarra</div>
        <br>
    {% if avisos %}
        {% for avis in avisos %}
            <div class="avis">
                <h3>{{ avis.titol }}</h3>
                <p>{{ avis.text | linebreaks }}</p>
            </div>
        {% endfor %}
    {% endif %}
    </div>

    <h2>Comanda</h2>
    <div class="totalbox">Total aproximat: <input type="text" class="total" disabled /></div>
    <div class="totalbox">Total amb increment: <input type="text" class="totalinc" disabled /></div>

    <form method="post" id="comanda">{% csrf_token %}
    {% if form %}
        {{ form.as_p }}
    {% endif %}
    <b style="background-color:yellow;">{{form.cleaned_data.data_recollida}}</b>
    <input type="submit" value="Envia" /> <br>

    <div id="accordion">
        {% for aprod in aproductes %}
            {% ifchanged aprod.activa_proveidor %}
                {% if forloop.first %}
                    <h3>{{aprod.producte.proveidor.nom}}</h3>
                    <div>
                {% else %}
                    </div>
                    <h3>{{aprod.producte.proveidor.nom}}</h3>
                    <div>
                {% endif %}
            {% endifchanged %}
                    <div id="producte-{{aprod.producte.id}}" class="{% cycle 'senar' 'parell' %}">
                        <div class="prod">{{aprod.producte.nom}}</div>
                        <input name="preu-{{aprod.producte.id}}" value="{{aprod.producte.preu}}" disabled>
                    {% if aprod.producte.granel %}
                        <input name="quantitat-{{aprod.producte.id}}" type="number" value="{{aprod.quantitat}}" step="0.1" />
                    {% else %}
                        <input name="quantitat-{{aprod.producte.id}}" type="number" value="{{aprod.quantitat}}" />
                    {% endif %}
                    
                    </div>
        {% endfor %}
            </div>
    </div>
    <input style="align:center" type="submit" value="Envia" />
    </form>

    <!-- precalcul total -->
    <div class="totalbox">Total aproximat: <input type="text" class="total" disabled /></div>
    <div class="totalbox">Total amb increment: <input type="text" class="totalinc" disabled /></div>

{% endblock %}


{% block custom_scripts %}
/*
 * Scripts per calcular total aproximat i subtotals
 */
{% load l10n %}

var total
function calcula_tot() {
    total = 0.0

    var qelems = $("[name^=quantitat]");

    qelems.each(function(index) {
        var quant = parseFloat( $(this).val() );
        var prod_id = $(this).attr("name").split("-")[1];
        var preustr = document.getElementsByName("preu-"+prod_id)[0].value;
        var preu = parseFloat(preustr.replace(",","."));

        if( quant ) {
            total += preu * quant;
            //console.log( prod_id+" "+preu );
        }
    })

    $('.total').val( total.toFixed(2) +" €")
    $('.totalinc').val( Math.round(100*total.toFixed(2)*(1+({{increment|unlocalize}})/100))/100 +" €")
}

calcula_tot()

$('select').change( calcula_tot )
$('input').change( calcula_tot )

{% endblock %}
